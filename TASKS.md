# 課題内容
## 基礎要件
<p>
API仕様書に記載されている機能を実装し、スゴリらん！クライアントからローカルAPIに通信した際に正常に動作する状態にしてください。

ベース実装ではWebフレームワークに `echo`、 データベース操作は標準パッケージの `database/sql` を利用しています。<br>
基本的にWebフレームワークや利用ライブラリの変更・追加は自由ですが、<br>
SQLを自身で書けるようになるという目的から **データベース操作にはORMを使わず** `database/sql` を利用してください。
</p>

### API仕様書
```
$ docker compose up swagger-ui
```
SwaggerUI: <http://localhost:3000/> <br> 
定義ファイル: `./api-document.yaml`<br>

### APIの実装順
APIの実装順は任意としますが、<br>
難易度や既存コード理解の観点から以下のAPIの順での実装を推奨します。
1. /user/update (hands on)
2. /collection/list
3. /ranking/list
4. /game/finish
5. /gacha/draw 

### 基礎要件で考慮すべき点
- /collection/list
  - n+1問題が発生していないか。
  - user_collection_item テーブルにレコードを追加し、正常に取得できていることを確認すること。
- /ranking/list
  - リクエストパラメータに不正な値が設定されている場合を考慮できているか。<br>
    (`start` にマイナス値やランキングに登録されているスコア数を超過した値が設定されている場合の考慮)
  - 不要なデータの取得を行っていないか。(ユーザーデータの全件取得等)
- /game/finish
  - リクエストパラメータに不正な値が設定されている場合を考慮できているか。<br>
    (`score` にマイナス値が設定されている場合の考慮)
  - 更新処理にTransactionを利用しているか。<br>
    (このAPIではレコードの更新は単一のためTransactionの実装は本来必須ではないが、ここで導入しておくと/gacha/draw APIの実装が楽になるため、/game/finish APIでTransactionの仕組みの実装・導入を行うこと。またこのAPIで実装したTransactionの仕組みを/gacha/draw APIでも利用すること。)
- /gacha/draw
  - リクエストパラメータに不正な値が設定されている場合を考慮できているか。<br>
    (`times` にマイナス値やAPIサーバやDBに負荷がかかってしまうような大きな値が設定されている場合の考慮)
  - n+1問題が発生していないか。
  - コレクションアイテムのINSERTクエリが獲得数分発行されていないか。<br>
    (更新負荷がかかる仕組みになってしまうためINSERTクエリはまとめること)
  - Transactionを利用して原子性が担保されているか。<br>
    (処理が途中でエラーになってしまっても中途半端なデータが保存されないこと)

## 応用要件
本リポジトリのベース実装には意図的にいくつかの課題やチャレンジポイントが含まれています。<br>
基礎要件に加えて、各人で課題の検討と対応を考え実践していきましょう。<br>
それぞれ例を挙げますので参考にしてみてください。

### 課題解決
- コレクションアイテムやガチャといった不変なデータ(マスタデータ)を毎回DBから取得している(パフォーマンスの課題)<br>
  → 不変なデータ(マスタデータ)をメモリキャッシュしてみる

- 実装のテストコードがない(品質の課題)<br>
  → ユニットテストのコードを追加してみる。ただしユニットテストの際のテストデータやDBアクセスをどうするか意識すること。

- アプリケーションの処理の役割や依存関係が整理されていない(アーキテクチャの課題)<br>
  → 「レイヤードアーキテクチャ」「クリーンアーキテクチャ」等で調べ、全体のパッケージ構成や依存を整理してみる。

- 誰がどんなアクセスをしてきたかわからない(調査やロギングの課題)<br>
  → 各APIがコールされた時にリクエストやレスポンスのログがサーバ上に出力されるようにしてみる

### チャレンジポイント

#### APIの内部的な改修
- ランキングの実装にredisを利用してみる
- ランキングを同率順位を考慮したものにしてみる
- 各設定値を定数ではなくデータベースで管理するようにしてみる

#### 負荷試験と計測
- 負荷試験ツールを利用して実際に負荷をかけてみる。
- コレクションアイテムやガチャのデータを数万件に増やしてみてボトルネックの調査やパフォーマンスチューニングをしてみる。
- pprof等、計測のツールを利用してボトルネックの調査やパフォーマンスチューニングをしてみる。
